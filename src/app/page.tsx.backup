'use client';

import { useState, useRef, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  Brain, Send, Loader2, Terminal, Cpu, Wifi, CheckCircle,
  Image as ImageIcon, X, Search, Code, Zap, Sparkles, Activity, FileText, Shield, Menu
} from 'lucide-react';

// === DASHBOARD COMPONENTS ===
import PCDashboard from '@/components/PCDashboard';
import DeepSearchResults from '@/components/DeepSearchResults';
import WorkerStatus from '@/components/WorkerStatus';
import TaskHistory from '@/components/TaskHistory';
import ConstitutionPanel from '@/components/ConstitutionPanel';

// === SEARCH RESULTS COMPONENT ===
const SearchResults = ({ results, answer, sources }: { results?: any[], answer?: string, sources?: any[] }) => {
  if (answer) {
    return (
      <div className="space-y-4">
        <div className="text-xs font-bold text-purple-400 flex items-center gap-1">
          <Sparkles className="w-3 h-3" />
          <span>DEEP SEARCH RESULTS</span>
        </div>
        <div className="text-gray-200 whitespace-pre-wrap text-sm leading-relaxed">{answer}</div>
        {sources && sources.length > 0 && (
          <div className="mt-4 pt-3 border-t border-white/10 flex flex-wrap gap-2">
            {sources.map((src, i) => (
              <a key={i} href={src.url} target="_blank" className="text-[10px] text-cyan-400 hover:underline bg-cyan-950/20 px-2 py-1 rounded-full border border-cyan-800/30">
                [{i+1}] {src.title?.substring(0, 30)}...
              </a>
            ))}
          </div>
        )}
      </div>
    );
  }
  if (!results || results.length === 0) return null;
  return (
    <div className="space-y-3 mt-2">
      <div className="text-xs font-bold text-cyan-400">🔍 SEARCH RESULTS ({results.length})</div>
      <div className="grid gap-2">
        {results.map((r, i) => (
          <a key={i} href={r.url} target="_blank" className="block bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg p-3 transition-all">
            <div className="text-sm font-medium text-white line-clamp-1">{r.title}</div>
            <div className="text-[10px] text-gray-500 mt-1 truncate">{r.url}</div>
          </a>
        ))}
      </div>
    </div>
  );
};

export default function SovereignInterface() {
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Array<any>>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [kernelStatus, setKernelStatus] = useState('checking');
  const [attachedImage, setAttachedImage] = useState<string | null>(null);
  const [attachedImagePreview, setAttachedImagePreview] = useState<string | null>(null);
  
  // === SIDEBAR STATE ===
  const [workers, setWorkers] = useState<any[]>([]);
  const [history, setHistory] = useState<any[]>([]);

  const fileInputRef = useRef<HTMLInputElement>(null);
  const scrollRef = useRef<HTMLDivElement>(null);

  // Fetch Workers on load
  useEffect(() => {
    fetch('/api/frontend/workers')
      .then(res => res.json())
      .then(data => setWorkers(data.workers || []))
      .catch(() => console.log("Using default worker data"));
  }, []);

  useEffect(() => {
    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [messages]);

  useEffect(() => {
    const checkKernel = async () => {
      try {
        const res = await fetch('/api/kernel');
        const data = await res.json();
        setKernelStatus(data.kernel === 'sovereign' ? 'sovereign' : 'online');
      } catch { setKernelStatus('offline'); }
    };
    checkKernel();
  }, []);

  const handlePaste = (e: React.ClipboardEvent) => {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        const file = items[i].getAsFile();
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setAttachedImage(reader.result as string);
            setAttachedImagePreview(URL.createObjectURL(file));
          };
          reader.readAsDataURL(file);
          e.preventDefault();
        }
        break;
      }
    }
  };

  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setAttachedImage(reader.result as string);
        setAttachedImagePreview(URL.createObjectURL(file));
      };
      reader.readAsDataURL(file);
    }
  };

  const removeImage = () => {
    setAttachedImage(null);
    setAttachedImagePreview(null);
    if(fileInputRef.current) fileInputRef.current.value = '';
  };

  const handleSend = async () => {
    if (!input.trim() && !attachedImage) return;

    const userMessage = { id: Date.now().toString(), role: 'user', content: input, image: attachedImagePreview };
    setMessages(prev => [...prev, userMessage]);
    
    // Add to History
    const newHistoryItem = { id: Date.now(), task: input, status: 'running', time: 'Now' };
    setHistory(prev => [newHistoryItem, ...prev]);

    setInput('');
    setIsLoading(true);
    const currentImage = attachedImage;
    removeImage();

    try {
      const res = currentImage
        ? await fetch('/api/workers/vision', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task: input || "Describe this image", image: currentImage.split(',')[1] }) })
        : await fetch('/api/kernel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task: input }) });

      const data = await res.json();
      
      // Update History status
      setHistory(prev => prev.map(h => h.id === newHistoryItem.id ? {...h, status: 'completed'} : h));

      setMessages(prev => [...prev, {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: data.code || data.output || data.analysis || data.error || 'Done.',
        stats: data.stats,
        results: data.results,
        answer: data.answer,
        sources: data.sources
      }]);
    } catch (error: any) {
      setMessages(prev => [...prev, { id: (Date.now() + 1).toString(), role: 'assistant', content: `❌ Crash: ${error.message}` }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="h-screen w-screen bg-black text-white flex overflow-hidden">
      
      {/* === SIDEBAR === */}
      <aside className="w-72 border-r border-white/10 bg-black/90 flex flex-col p-4 gap-6">
        <div className="flex items-center gap-2 pb-4 border-b border-white/10">
          <Brain className="w-5 h-5 text-violet-400" />
          <span className="font-bold text-sm">REZ HIVE</span>
        </div>

        <div className="flex-1 overflow-hidden space-y-6">
           <WorkerStatus workers={workers} />
           <TaskHistory history={history} />
           <ConstitutionPanel />
        </div>
      </aside>

      {/* === MAIN CHAT INTERFACE === */}
      <div className="flex-1 flex flex-col relative">
        <header className="absolute top-0 left-0 right-0 z-20 flex items-center justify-between px-6 py-3 border-b border-white/10 bg-black/80 backdrop-blur-sm">
          <div className="flex items-center gap-3">
            <div className={`w-2 h-2 rounded-full animate-pulse ${kernelStatus === 'sovereign' ? 'bg-emerald-500' : 'bg-red-500'}`} />
            <h1 className="text-sm font-medium text-gray-300">REZ INTERFACE</h1>
            <Badge variant="outline" className="text-[10px] border-white/20 text-gray-500">v2.3 Sovereign</Badge>
          </div>
          <Badge variant="outline" className={`border-white/10 ${kernelStatus === 'sovereign' ? 'text-emerald-400' : 'text-red-400'}`}>
            <Wifi className="w-3 h-3 mr-1" /> {kernelStatus === 'sovereign' ? 'Sovereign' : 'Offline'}
          </Badge>
        </header>

        <main className="flex-1 overflow-hidden pt-14">
          <ScrollArea className="h-full" ref={scrollRef}>
            <div className="max-w-3xl mx-auto px-6 py-8 space-y-6">
              {messages.length === 0 ? (
                <div className="h-[70vh] flex flex-col items-center justify-center text-center">
                  <Brain className="w-10 h-10 text-purple-400 mb-6" />
                  <h2 className="text-3xl font-light text-gray-200 mb-2">Ready.</h2>
                  <p className="text-gray-600 text-sm mb-6">Paste (Ctrl+V) a screenshot or type a command:</p>
                  <div className="flex flex-wrap justify-center gap-2 max-w-xl">
                    {[
                      { icon: Search, label: 'Search Web', prompt: 'Search the web for ' },
                      { icon: ImageIcon, label: 'Analyze Screen', prompt: 'What do you see?' },
                      { icon: Code, label: 'Write Code', prompt: 'Create a Python script for ' },
                      { icon: Cpu, label: 'PC Health', prompt: 'Check system health' },
                      { icon: Sparkles, label: 'Deep Research', prompt: 'Deep search: ' },
                      { icon: Terminal, label: 'Launch Notepad', prompt: 'Launch notepad' }
                    ].map((cmd, idx) => (
                      <button key={idx} onClick={() => setInput(cmd.prompt)} className="flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-purple-500/50 transition-all text-xs text-gray-300">
                        <cmd.icon className="w-3 h-3" /> {cmd.label}
                      </button>
                    ))}
                  </div>
                </div>
              ) : (
                messages.map((msg) => (
                  <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[85%] ${msg.role === 'user' ? 'bg-purple-600/20 border border-purple-500/30' : 'bg-white/5 border border-white/10'} rounded-2xl p-4`}>
                      {msg.image && <img src={msg.image} alt="Attached" className="rounded-lg max-h-60 mb-2" />}
                      {msg.role === 'assistant' ? (
                        msg.stats ? (
                          <PCDashboard stats={msg.stats} />
                        ) : msg.results ? (
                          <SearchResults results={msg.results} />
                        ) : msg.answer ? (
                          <SearchResults answer={msg.answer} sources={msg.sources} />
                        ) : (
                          <pre className="text-sm text-gray-300 whitespace-pre-wrap font-mono">{msg.content}</pre>
                        )
                      ) : (
                        <p className="text-sm text-gray-200">{msg.content}</p>
                      )}
                    </div>
                  </div>
                ))
              )}
              {isLoading && (
                <div className="flex justify-start">
                  <div className="flex items-center gap-2 text-gray-400 bg-white/5 px-4 py-2 rounded-lg">
                    <Loader2 className="w-4 h-4 animate-spin" /> <span className="text-xs">Thinking...</span>
                  </div>
                </div>
              )}
            </div>
          </ScrollArea>
        </main>

        <footer className="relative z-20 p-6 border-t border-white/10 bg-black/80">
          <div className="max-w-3xl mx-auto">
            {attachedImagePreview && (
              <div className="relative inline-block mb-3">
                <img src={attachedImagePreview} alt="Preview" className="h-20 rounded-lg border border-white/10" />
                <Button variant="destructive" size="icon" className="absolute -top-2 -right-2 h-5 w-5 rounded-full" onClick={removeImage}><X className="w-3 h-3" /></Button>
              </div>
            )}
            <div className="flex gap-4 items-end">
              <input type="file" accept="image/*" ref={fileInputRef} onChange={handleImageSelect} className="hidden" />
              <Button onClick={() => fileInputRef.current?.click()} size="icon" className="bg-transparent hover:bg-white/10 text-gray-400"><ImageIcon className="w-5 h-5" /></Button>
              <Textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())} onPaste={handlePaste} placeholder="Paste (Ctrl+V) screenshot or type command..." className="flex-1 bg-white/5 border-white/10 text-white min-h-[40px]" rows={1} />
              <Button onClick={handleSend} size="icon" className="bg-purple-600 hover:bg-purple-700 h-10 w-10" disabled={isLoading}><Send className="w-4 h-4" /></Button>
            </div>
          </div>
        </footer>
      </div>
    </div>
  );
}
