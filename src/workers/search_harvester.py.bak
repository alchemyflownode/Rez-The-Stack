import sys
import json
import time

def harvest(query):
    try:
        # 1. ROBUST IMPORT
        ddgs_module = None
        try:
            from duckduckgo_search import DDGS
            ddgs_module = DDGS
        except ImportError:
            try:
                from ddgs import DDGS
                ddgs_module = DDGS
            except ImportError as e:
                return {"success": False, "error": f"Import failed: {e}. Run: pip install duckduckgo-search"}

        # 2. EXECUTE SEARCH
        results = []
        images = []
        
        # Clean query
        clean_q = query + " latest developments 2025"
        
        with ddgs_module() as ddgs:
            try:
                # Text
                for r in ddgs.text(clean_q, region='us-en', max_results=5):
                    results.append({
                        "title": r.get("title", ""),
                        "href": r.get("href", ""),
                        "body": r.get("body", "")
                    })
            except Exception as e:
                # Handle Rate Limits specifically
                if "403" in str(e):
                    return {"success": False, "error": "Rate limit hit. Please wait."}
                pass # Continue without text if partial failure

            try:
                # Images
                for r in ddgs.images(query, max_results=3):
                    images.append({
                        "image": r.get("image", ""),
                        "thumbnail": r.get("thumbnail", ""),
                        "title": r.get("title", "")
                    })
            except:
                pass

        return {
            "success": True,
            "query": query,
            "results": results,
            "images": images,
            "answer": f"Found {len(results)} sources."
        }

    except Exception as e:
        return {"success": False, "error": str(e)}

if __name__ == "__main__":
    q = sys.argv[1] if len(sys.argv) > 1 else "test"
    print(json.dumps(harvest(q), indent=2))


